<script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCz5GKCJfazH9e-4z4X5QNd4o9BZV8gMoU",
            authDomain: "dul-accounts.firebaseapp.com",
            projectId: "dul-accounts",
            storageBucket: "dul-accounts.firebasestorage.app",
            messagingSenderId: "508206162333",
            appId: "1:508206162333:web:8fe26acd229aea1a93cf74"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Telegraph API endpoint
        const TELEGRAPH_UPLOAD_URL = 'https://telegra.ph/upload';

        // Global variables
        window.payments = [];
        let unsubscribe = null;
        let syncTimeout = null;
        let currentUser = null;
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let pendingSave = false;
        let uploadRetryCount = 0;
        const MAX_UPLOAD_RETRIES = 3;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('App starting...');
            
            loadLocalData();
            updateUI();
            setupFileInputs();
            
            await initFirebase();
            setupNetworkMonitoring();
        });

        async function initFirebase() {
            try {
                console.log('Initializing Firebase...');
                
                try {
                    await db.enablePersistence({ 
                        synchronizeTabs: true 
                    });
                    console.log('Persistence enabled');
                } catch (err) {
                    if (err.code === 'failed-precondition') {
                        console.warn('Multiple tabs open, persistence only works in one tab');
                    } else if (err.code === 'unimplemented') {
                        console.warn('Browser does not support persistence');
                    }
                }

                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                console.log('Auth persistence set');
                
                auth.onAuthStateChanged(async (user) => {
                    console.log('Auth state changed:', user ? 'Authenticated' : 'Not authenticated');
                    await handleAuthStateChange(user);
                });
                
                if (!auth.currentUser) {
                    await signInUser();
                }
            } catch (error) {
                console.error('Firebase init error:', error);
                handleOfflineMode();
            }
        }

        async function signInUser() {
            try {
                console.log('Attempting sign in...');
                const credential = await auth.signInAnonymously();
                currentUser = credential.user;
                console.log('Signed in successfully:', currentUser.uid);
                return true;
            } catch (error) {
                console.error('Sign in error:', error);
                if (isOnline) {
                    setTimeout(signInUser, 3000);
                }
                return false;
            }
        }

        async function handleAuthStateChange(user) {
            if (user) {
                currentUser = user;
                console.log('User authenticated:', user.uid);
                
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
                
                setupRealtimeSync();
                
                if (isOnline) {
                    updateSyncStatus('syncing');
                    await syncToFirebase();
                }
            } else {
                currentUser = null;
                console.log('User not authenticated');
                
                if (unsubscribe) {
                    unsubscribe();
                    unsubscribe = null;
                }
                
                if (isOnline) {
                    await signInUser();
                } else {
                    handleOfflineMode();
                }
            }
        }

        function setupRealtimeSync() {
            console.log('Setting up realtime sync...');
            
            unsubscribe = db.collection('payments')
                .doc('shared')
                .onSnapshot(
                    {
                        includeMetadataChanges: true
                    },
                    (doc) => {
                        console.log('Snapshot received, fromCache:', doc.metadata.fromCache);
                        
                        if (doc.exists) {
                            const data = doc.data();
                            
                            if (!doc.metadata.fromCache && data && data.payments) {
                                console.log('Updating from server data');
                                window.payments = data.payments;
                                saveLocalData();
                                updateUI();
                            }
                            
                            if (!doc.metadata.hasPendingWrites) {
                                if (doc.metadata.fromCache) {
                                    updateSyncStatus('offline');
                                } else {
                                    updateSyncStatus('synced');
                                    isSyncing = false;
                                    uploadRetryCount = 0;
                                }
                            }
                        }
                    },
                    (error) => {
                        console.error('Snapshot error:', error);
                        if (error.code === 'permission-denied') {
                            console.log('Permission denied, re-authenticating...');
                            signInUser();
                        } else {
                            updateSyncStatus('offline');
                        }
                    }
                );
        }

        async function syncToFirebase() {
            if (!currentUser || !isOnline) {
                console.log('Cannot sync: no user or offline');
                return;
            }
            
            if (isSyncing) {
                pendingSave = true;
                console.log('Sync already in progress, queuing...');
                return;
            }
            
            isSyncing = true;
            pendingSave = false;
            updateSyncStatus('syncing');
            
            try {
                console.log('Starting sync to Firebase...');
                
                const doc = await db.collection('payments').doc('shared').get({ source: 'server' });
                
                if (!doc.exists && window.payments.length > 0) {
                    console.log('No remote data, uploading local');
                    await uploadToFirebase();
                } else if (doc.exists) {
                    const remoteData = doc.data();
                    if (remoteData && remoteData.payments) {
                        console.log('Using server data');
                        window.payments = remoteData.payments;
                        saveLocalData();
                        updateUI();
                    }
                }
                
                updateSyncStatus('synced');
                console.log('Sync completed successfully');
                uploadRetryCount = 0;
            } catch (error) {
                console.error('Sync error:', error);
                updateSyncStatus('offline');
            } finally {
                isSyncing = false;
                
                if (pendingSave) {
                    console.log('Processing queued save...');
                    setTimeout(() => saveToFirebase(), 500);
                }
            }
        }

        async function saveToFirebase() {
            if (!currentUser || !isOnline) {
                console.log('Cannot save: no user or offline');
                saveLocalData();
                return;
            }
            
            if (isSyncing) {
                pendingSave = true;
                console.log('Save queued');
                return;
            }
            
            if (syncTimeout) {
                clearTimeout(syncTimeout);
            }
            
            isSyncing = true;
            pendingSave = false;
            updateSyncStatus('syncing');
            
            syncTimeout = setTimeout(async () => {
                try {
                    await uploadToFirebase();
                    console.log('Save successful');
                    
                    setTimeout(() => {
                        if (!pendingSave) {
                            updateSyncStatus('synced');
                            isSyncing = false;
                            uploadRetryCount = 0;
                        }
                    }, 2000);
                } catch (error) {
                    console.error('Save error:', error);
                    
                    if (uploadRetryCount < MAX_UPLOAD_RETRIES) {
                        uploadRetryCount++;
                        console.log(`Retrying upload... (${uploadRetryCount}/${MAX_UPLOAD_RETRIES})`);
                        updateSyncStatus('syncing');
                        isSyncing = false;
                        setTimeout(() => saveToFirebase(), 2000 * uploadRetryCount);
                    } else {
                        updateSyncStatus('offline');
                        isSyncing = false;
                        uploadRetryCount = 0;
                        alert('Failed to sync. Your data is saved locally and will sync when connection improves.');
                    }
                }
            }, 1000);
        }

        async function uploadToFirebase() {
            console.log('Uploading to Firebase...');
            const dataSize = JSON.stringify(window.payments).length;
            console.log(`Upload size: ${(dataSize / 1024 / 1024).toFixed(2)} MB`);
            
            await db.collection('payments').doc('shared').set({
                payments: window.payments,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                userId: currentUser.uid
            });
        }

        function handleOfflineMode() {
            console.log('Running in offline mode');
            updateSyncStatus('offline');
            isSyncing = false;
            
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
        }

        function setupNetworkMonitoring() {
            window.addEventListener('online', async () => {
                console.log('Network: online');
                isOnline = true;
                
                if (!currentUser) {
                    await signInUser();
                } else {
                    updateSyncStatus('syncing');
                    await syncToFirebase();
                }
            });

            window.addEventListener('offline', () => {
                console.log('Network: offline');
                isOnline = false;
                handleOfflineMode();
            });
        }

        function saveLocalData() {
            try {
                localStorage.setItem('dulPayments', JSON.stringify(window.payments));
                localStorage.setItem('dulPaymentsTimestamp', Date.now().toString());
                console.log('Local data saved');
            } catch (e) {
                console.error('Failed to save local data:', e);
            }
        }

        function loadLocalData() {
            try {
                const data = localStorage.getItem('dulPayments');
                if (data) {
                    window.payments = JSON.parse(data);
                    console.log('Local data loaded:', window.payments.length, 'payments');
                }
            } catch (e) {
                console.error('Failed to load local data:', e);
                window.payments = [];
            }
        }

        function updateUI() {
            updateStats();
            renderRecentPayments();
            renderPendingPayments();
            renderApprovedPayments();
            renderSentPayments();
            renderCashControl();
        }

        function updateSyncStatus(status) {
            const syncEl = document.getElementById('syncStatus');
            if (!syncEl) return;
            
            const dotEl = syncEl.querySelector('.sync-dot');
            const textEl = syncEl.querySelector('span');
            
            syncEl.className = `sync-status ${status}`;
            if (dotEl) dotEl.className = `sync-dot ${status}`;
            
            if (textEl) {
                switch(status) {
                    case 'syncing':
                        textEl.textContent = 'Syncing...';
                        break;
                    case 'synced':
                        textEl.textContent = 'Synced';
                        break;
                    default:
                        textEl.textContent = 'Offline';
                }
            }
            
            console.log('Sync status:', status);
        }

        // IMAGE COMPRESSION FUNCTION
        async function compressImage(file, maxWidth = 1200, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = new Image();
                    
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        canvas.toBlob(
                            (blob) => {
                                const compressedFile = new File([blob], file.name, {
                                    type: 'image/jpeg',
                                    lastModified: Date.now()
                                });
                                
                                const originalSize = (file.size / 1024).toFixed(2);
                                const compressedSize = (compressedFile.size / 1024).toFixed(2);
                                const reduction = ((1 - compressedFile.size / file.size) * 100).toFixed(0);
                                
                                console.log(`Image compressed: ${originalSize}KB -> ${compressedSize}KB (${reduction}% reduction)`);
                                
                                resolve(compressedFile);
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // UPLOAD IMAGE TO TELEGRAPH
        async function uploadImageToTelegraph(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                console.log('Uploading to Telegraph...');
                const response = await fetch(TELEGRAPH_UPLOAD_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`Telegraph upload failed: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data && data[0] && data[0].src) {
                    const imageUrl = 'https://telegra.ph' + data[0].src;
                    console.log('Image uploaded to Telegraph:', imageUrl);
                    return imageUrl;
                } else {
                    throw new Error('Invalid response from Telegraph');
                }
            } catch (error) {
                console.error('Telegraph upload error:', error);
                throw error;
            }
        }

        // Form handlers
        window.handleCategoryChange = function() {
            const category = document.getElementById('paymentCategory').value;
            const typeGroup = document.getElementById('paymentTypeGroup');
            const methodGroup = document.getElementById('paymentMethodGroup');
            const typeSelect = document.getElementById('paymentType');
            const methodSelect = document.getElementById('paymentMethod');
            
            if (category === 'Banking') {
                typeGroup.style.display = 'none';
                typeSelect.value = 'expense';
                typeSelect.removeAttribute('required');
                
                methodGroup.style.display = 'block';
                methodSelect.innerHTML = '<option value="cash">Cash</option>';
                methodSelect.value = 'cash';
                methodSelect.setAttribute('required', 'required');
            } else {
                typeGroup.style.display = 'block';
                typeSelect.setAttribute('required', 'required');
                
                methodSelect.innerHTML = `
                    <option value="bank">Bank Transfer</option>
                    <option value="cash">Cash</option>
                    <option value="cheque">Cheque</option>
                `;
                handleTypeChange();
            }
        };

        window.handleTypeChange = function() {
            const category = document.getElementById('paymentCategory').value;
            if (category === 'Banking') return;
            
            const methodGroup = document.getElementById('paymentMethodGroup');
            methodGroup.style.display = 'block';
            document.getElementById('paymentMethod').setAttribute('required', 'required');
        };

        window.showAddPayment = function() {
            const modal = document.getElementById('addPaymentModal');
            if (modal) {
                modal.classList.add('active');
                handleCategoryChange();
                setTimeout(setupFileInputs, 100);
            }
        };

        window.closeModal = function(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        };

        window.closeImageModal = function() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.classList.remove('active');
            }
        };

        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal') || e.target.classList.contains('image-modal')) {
                e.target.classList.remove('active');
            }
        });

        window.switchView = function(view) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(view + 'View').classList.add('active');
            event.currentTarget.classList.add('active');
            
            if (view === 'pending') renderPendingPayments();
            if (view === 'approved') renderApprovedPayments();
            if (view === 'cashControl') renderCashControl();
            if (view === 'sent') renderSentPayments();
        };

        window.addPayment = async function(event) {
            event.preventDefault();
            
            const cameraFile = document.getElementById('invoiceFileCamera').files[0];
            const uploadFile = document.getElementById('invoiceFileUpload').files[0];
            let invoiceFile = cameraFile || uploadFile;
            
            if (invoiceFile) {
                if (invoiceFile.type.startsWith('image/')) {
                    try {
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        const loadingText = loadingOverlay.querySelector('.loading-text');
                        const loadingSubtext = loadingOverlay.querySelector('.loading-subtext');
                        
                        // Compress image
                        loadingOverlay.classList.add('active');
                        loadingText.textContent = 'Compressing Image...';
                        loadingSubtext.textContent = 'Optimizing for upload';
                        
                        invoiceFile = await compressImage(invoiceFile);
                        
                        // Upload to Telegraph
                        loadingText.textContent = 'Uploading Image...';
                        loadingSubtext.textContent = 'Uploading to cloud';
                        
                        const imageUrl = await uploadImageToTelegraph(invoiceFile);
                        
                        loadingOverlay.classList.remove('active');
                        loadingText.textContent = 'Scanning Invoice...';
                        loadingSubtext.textContent = 'Extracting data from image';
                        
                        const invoiceData = {
                            name: invoiceFile.name,
                            type: invoiceFile.type,
                            url: imageUrl,
                            uploadedAt: new Date().toISOString()
                        };
                        
                        savePaymentWithInvoice(invoiceData, Date.now().toString());
                        
                    } catch (error) {
                        console.error('Image processing error:', error);
                        const loadingOverlay = document.getElementById('loadingOverlay');
                        loadingOverlay.classList.remove('active');
                        alert('Failed to upload image. Please check your internet connection and try again.');
                    }
                } else if (invoiceFile.type === 'application/pdf') {
                    // For PDFs, store as base64 (they're usually smaller)
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        const invoiceData = {
                            name: invoiceFile.name,
                            type: invoiceFile.type,
                            data: reader.result
                        };
                        savePaymentWithInvoice(invoiceData, Date.now().toString());
                    };
                    reader.readAsDataURL(invoiceFile);
                }
            } else {
                savePaymentWithInvoice(null, Date.now().toString());
            }
        };

        function savePaymentWithInvoice(invoiceData, paymentId) {
            const category = document.getElementById('paymentCategory').value;
            let type, paymentMethod;
            
            if (category === 'Banking') {
                type = 'expense';
                paymentMethod = 'cash';
            } else {
                type = document.getElementById('paymentType').value;
                paymentMethod = document.getElementById('paymentMethod').value;
            }
            
            const payment = {
                id: paymentId,
                description: document.getElementById('paymentDesc').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                category: category,
                type: type,
                paymentMethod: paymentMethod,
                notes: document.getElementById('paymentNotes').value,
                invoice: invoiceData,
                status: 'pending',
                createdAt: new Date().toISOString(),
                date: new Date().toISOString().split('T')[0]
            };

            window.payments.unshift(payment);
            saveLocalData();
            saveToFirebase();
            closeModal('addPaymentModal');
            
            document.querySelector('#addPaymentModal form').reset();
            document.getElementById('invoiceFileName').textContent = '';
            document.getElementById('invoicePreview').classList.remove('active');
            
            updateUI();
        }

        window.approvePayment = function(id) {
            const payment = window.payments.find(p => p.id === id);
            if (payment) {
                if (payment.type === 'income' && payment.paymentMethod === 'cash') {
                    payment.status = 'in-pot';
                } else {
                    payment.status = 'approved';
                }
                saveLocalData();
                saveToFirebase();
                updateUI();
            }
        };

        window.markAsSent = function(id) {
            const payment = window.payments.find(p => p.id === id);
            if (payment) {
                const cashPot = calculateCashPot();
                
                if (payment.paymentMethod === 'cash' && payment.type === 'expense') {
                    if (cashPot < payment.amount) {
                        alert(`Insufficient cash. Available: £${cashPot.toFixed(2)}, Required: £${payment.amount.toFixed(2)}`);
                        return;
                    }
                }
                
                payment.status = 'sent';
                payment.sentAt = new Date().toISOString();
                saveLocalData();
                saveToFirebase();
                updateUI();
            }
        };

        window.deletePayment = function(id) {
            const payment = window.payments.find(p => p.id === id);
            if (!payment) return;
            
            let confirmMessage = 'Delete this payment?';
            
            // Add warning for cash pot or sent payments
            if (payment.status === 'in-pot' && payment.paymentMethod === 'cash' && payment.type === 'income') {
                confirmMessage = `Delete this payment?\n\nThis will remove £${payment.amount.toFixed(2)} from the cash pot.`;
            } else if (payment.status === 'sent' && payment.paymentMethod === 'cash' && payment.type === 'expense') {
                confirmMessage = `Delete this payment?\n\nThis will add £${payment.amount.toFixed(2)} back to the cash pot.`;
            } else if (payment.status === 'sent') {
                confirmMessage = `Delete this sent payment?\n\n${payment.description} - £${payment.amount.toFixed(2)}`;
            }
            
            if (!confirm(confirmMessage)) return;
            
            window.payments = window.payments.filter(p => p.id !== id);
            saveLocalData();
            saveToFirebase();
            updateUI();
            
            // Show confirmation
            const statusEl = document.getElementById('syncStatus');
            const originalText = statusEl.querySelector('span').textContent;
            statusEl.querySelector('span').textContent = 'Deleted';
            setTimeout(() => {
                if (statusEl.querySelector('span')) {
                    statusEl.querySelector('span').textContent = originalText;
                }
            }, 2000);
        };

        window.viewInvoice = function(id) {
            const payment = window.payments.find(p => p.id === id);
            if (!payment || !payment.invoice) return;
            
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalTitle = document.getElementById('imageModalTitle');
            
            if (payment.invoice.type.includes('pdf')) {
                const pdfData = payment.invoice.data;
                const win = window.open('', '_blank');
                win.document.write(`
                    <iframe src="${pdfData}" 
                            style="width:100%; height:100vh; border:none;" 
                            title="${payment.invoice.name}">
                    </iframe>
                `);
            } else {
                // Use URL from Telegraph or fallback to base64 data
                const imageSource = payment.invoice.url || payment.invoice.data;
                if (imageSource) {
                    modalImage.src = imageSource;
                    modalTitle.textContent = payment.invoice.name || 'Invoice';
                    modal.classList.add('active');
                } else {
                    alert('Invoice image not found.');
                }
            }
        };

        function calculateCashPot() {
            const cashIn = window.payments
                .filter(p => p.type === 'income' && p.paymentMethod === 'cash' && p.status === 'in-pot')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const cashOut = window.payments
                .filter(p => p.type === 'expense' && p.paymentMethod === 'cash' && p.status === 'sent')
                .reduce((sum, p) => sum + p.amount, 0);
            
            return cashIn - cashOut;
        }

        function updateStats() {
            const pending = window.payments.filter(p => p.status === 'pending').length;
            const approved = window.payments.filter(p => p.status === 'approved').length;
            const cashPot = calculateCashPot();
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthPayments = window.payments.filter(p => p.date?.startsWith(currentMonth));
            
            const expense = monthPayments
                .filter(p => p.type === 'expense' && p.status === 'sent' && p.category !== 'Banking')
                .reduce((sum, p) => sum + p.amount, 0);
            
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('cashPot').textContent = '£' + cashPot.toFixed(2);
            document.getElementById('cashPotDetail').textContent = '£' + cashPot.toFixed(2);
            document.getElementById('monthExpense').textContent = '£' + expense.toFixed(2);
            
            const pendingBadge = document.getElementById('pendingBadge');
            const approvedBadge = document.getElementById('approvedBadge');
            
            if (pending > 0) {
                pendingBadge.textContent = pending;
                pendingBadge.style.display = 'block';
            } else {
                pendingBadge.style.display = 'none';
            }
            
            if (approved > 0) {
                approvedBadge.textContent = approved;
                approvedBadge.style.display = 'block';
            } else {
                approvedBadge.style.display = 'none';
            }
        }

        function renderPaymentCard(payment) {
            const statusClass = `status-${payment.status}`;
            let statusText = payment.status.charAt(0).toUpperCase() + payment.status.slice(1);
            if (payment.status === 'in-pot') statusText = 'In Pot';
            
            const methodIcon = payment.paymentMethod === 'cash' ? '💵' : 
                              payment.paymentMethod === 'cheque' ? '📝' : '🏦';
            
            let actions = '';
            if (payment.status === 'pending') {
                actions = `
                    <div class="payment-actions">
                        <button class="btn btn-approve" onclick="approvePayment('${payment.id}')">Approve</button>
                        <button class="btn btn-delete" onclick="deletePayment('${payment.id}')">Delete</button>
                    </div>
                `;
            } else if (payment.status === 'approved') {
                actions = `
                    <div class="payment-actions">
                        <button class="btn btn-send" onclick="markAsSent('${payment.id}')">Mark Sent</button>
                        <button class="btn btn-secondary" onclick="deletePayment('${payment.id}')">Delete</button>
                    </div>
                `;
            } else if (payment.status === 'sent' || payment.status === 'in-pot') {
                actions = `
                    <div class="payment-actions">
                        <button class="btn btn-delete" onclick="deletePayment('${payment.id}')">Delete</button>
                    </div>
                `;
            }
            
            const invoiceButton = payment.invoice ? 
                `<button class="btn-view" onclick="viewInvoice('${payment.id}')">📄 Invoice</button>` : '';
            
            return `
                <div class="payment-card">
                    <div class="payment-header">
                        <div style="flex: 1;">
                            <div class="payment-title">${payment.description}</div>
                            <div class="payment-category">${payment.category}</div>
                        </div>
                        <div class="payment-amount">£${payment.amount.toFixed(2)}</div>
                    </div>
                    <div class="payment-meta">
                        <div class="payment-meta-item">
                            ${payment.type === 'income' ? '↑' : '↓'} ${payment.type === 'income' ? 'In' : 'Out'}
                        </div>
                        <div class="payment-meta-item">
                            ${methodIcon} ${payment.paymentMethod.charAt(0).toUpperCase() + payment.paymentMethod.slice(1)}
                        </div>
                        <div class="payment-meta-item">
                            📅 ${new Date(payment.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}
                        </div>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    ${payment.notes ? `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; line-height: 1.4;">${payment.notes}</div>` : ''}
                    ${invoiceButton}
                    ${actions}
                </div>
            `;
        }

        function renderRecentPayments() {
            const container = document.getElementById('recentPayments');
            const recent = window.payments.slice(0, 10);
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">💰</div>
                        <div class="title">No payments yet</div>
                        <div class="subtitle">Tap the + button to create your first payment</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(renderPaymentCard).join('');
        }

        function renderPendingPayments() {
            const container = document.getElementById('pendingPayments');
            const pending = window.payments.filter(p => p.status === 'pending');
            
            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">✅</div>
                        <div class="title">All caught up!</div>
                        <div class="subtitle">No payments pending approval</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pending.map(renderPaymentCard).join('');
        }

        function renderApprovedPayments() {
            const container = document.getElementById('approvedPayments');
            const approved = window.payments.filter(p => p.status === 'approved');
            
            if (approved.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">🔭</div>
                        <div class="title">Nothing to send</div>
                        <div class="subtitle">No approved payments waiting</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = approved.map(renderPaymentCard).join('');
        }

        function renderCashControl() {
            const container = document.getElementById('cashPayments');
            const cashPayments = window.payments.filter(p => 
                (p.type === 'income' && p.paymentMethod === 'cash' && p.status === 'in-pot') ||
                (p.type === 'expense' && p.paymentMethod === 'cash' && p.status === 'sent')
            ).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            if (cashPayments.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">💵</div>
                        <div class="title">No cash transactions</div>
                        <div class="subtitle">Cash income and expenses will appear here</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = cashPayments.map(renderPaymentCard).join('');
        }

        function renderSentPayments() {
            const container = document.getElementById('sentPayments');
            const sent = window.payments.filter(p => p.status === 'sent');
            
            if (sent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📬</div>
                        <div class="title">No sent payments</div>
                        <div class="subtitle">Completed payments will appear here</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sent.map(renderPaymentCard).join('');
        }

        // OCR and file handling
        async function processInvoice(file) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const preview = document.getElementById('invoicePreview');
            const previewImage = document.getElementById('previewImage');
            
            try {
                loadingOverlay.classList.add('active');
                
                const imageUrl = URL.createObjectURL(file);
                previewImage.src = imageUrl;
                previewImage.style.display = 'block';
                
                console.log('Starting OCR processing...');
                
                const result = await Tesseract.recognize(
                    file,
                    'eng',
                    {
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                const subtext = document.querySelector('.loading-subtext');
                                if (subtext) {
                                    subtext.textContent = `Processing... ${progress}%`;
                                }
                            }
                        }
                    }
                );
                
                const text = result.data.text;
                console.log('Extracted text:', text);
                
                const extractedData = extractInvoiceData(text);
                console.log('Parsed data:', extractedData);
                
                loadingOverlay.classList.remove('active');
                preview.classList.add('active');
                
                displayExtractedData(extractedData);
                
                setTimeout(() => {
                    autoFillForm(extractedData);
                }, 100);
                
            } catch (error) {
                console.error('OCR Error:', error);
                loadingOverlay.classList.remove('active');
                alert('Could not read invoice. Please fill in manually.');
            }
        }

        function extractInvoiceData(text) {
            const data = {
                amount: null,
                description: null,
                supplier: null,
                date: null,
                invoiceNumber: null
            };
            
            const amountPatterns = [
                /(?:total|amount|balance|due|pay)[\s:£]*(\d+\.?\d{0,2})/gi,
                /£\s*(\d+\.?\d{0,2})/g,
                /(\d+\.\d{2})(?:\s*GBP)?/g
            ];
            
            for (const pattern of amountPatterns) {
                const matches = text.match(pattern);
                if (matches && matches.length > 0) {
                    const nums = matches.map(m => {
                        const num = m.match(/\d+\.?\d{0,2}/);
                        return num ? parseFloat(num[0]) : 0;
                    });
                    data.amount = Math.max(...nums);
                    if (data.amount > 0) break;
                }
            }
            
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            if (lines.length > 0) {
                data.supplier = lines[0].trim();
                data.description = `Invoice from ${data.supplier}`;
            }
            
            const invoiceMatch = text.match(/(?:invoice|inv|bill)[\s#:]*(\w+\d+)/gi);
            if (invoiceMatch) {
                data.invoiceNumber = invoiceMatch[0].replace(/(?:invoice|inv|bill)[\s#:]*/gi, '');
            }
            
            const dateMatch = text.match(/\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}/);
            if (dateMatch) {
                data.date = dateMatch[0];
            }
            
            return data;
        }

        function extractFromFilename(filename) {
            const data = {
                amount: null,
                description: null,
                supplier: null,
                date: null,
                invoiceNumber: null
            };
            
            const invoiceMatch = filename.match(/(?:invoice|inv|bill|INV|T0)[\s_-]*(\d+)/i);
            if (invoiceMatch) {
                data.invoiceNumber = invoiceMatch[1];
                data.description = `Invoice #${data.invoiceNumber}`;
            } else {
                data.description = filename.replace(/\.[^/.]+$/, '').replace(/_/g, ' ');
            }
            
            const dateMatch = filename.match(/(\d{4}[-_]\d{2}[-_]\d{2})/);
            if (dateMatch) {
                data.date = dateMatch[1].replace(/_/g, '-');
            }
            
            return data;
        }

        function displayExtractedData(data) {
            const container = document.getElementById('extractedData');
            let html = '';
            
            if (data.amount) {
                html += `
                    <div class="extracted-item">
                        <div class="extracted-label">Amount</div>
                        <div class="extracted-value">£${data.amount.toFixed(2)}</div>
                    </div>
                `;
            }
            
            if (data.supplier) {
                html += `
                    <div class="extracted-item">
                        <div class="extracted-label">Supplier</div>
                        <div class="extracted-value">${data.supplier}</div>
                    </div>
                `;
            }
            
            if (data.invoiceNumber) {
                html += `
                    <div class="extracted-item">
                        <div class="extracted-label">Invoice #</div>
                        <div class="extracted-value">${data.invoiceNumber}</div>
                    </div>
                `;
            }
            
            if (data.date) {
                html += `
                    <div class="extracted-item">
                        <div class="extracted-label">Date</div>
                        <div class="extracted-value">${data.date}</div>
                    </div>
                `;
            }
            
            if (html === '') {
                html = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No data extracted. Please fill manually.</div>';
            }
            
            container.innerHTML = html;
        }

        function autoFillForm(data) {
            console.log('Auto-filling form with:', data);
            
            if (data.amount && data.amount > 0) {
                const amountField = document.getElementById('paymentAmount');
                if (amountField) {
                    amountField.value = data.amount.toFixed(2);
                    amountField.style.borderColor = 'var(--primary)';
                }
            }
            
            if (data.description) {
                const descField = document.getElementById('paymentDesc');
                if (descField) {
                    descField.value = data.description;
                    descField.style.borderColor = 'var(--primary)';
                }
            }
            
            if (data.invoiceNumber || data.date) {
                const notes = document.getElementById('paymentNotes');
                if (notes) {
                    let noteText = '';
                    if (data.invoiceNumber) {
                        noteText = `Invoice #${data.invoiceNumber}`;
                    }
                    if (data.date) {
                        noteText += noteText ? `\nDate: ${data.date}` : `Date: ${data.date}`;
                    }
                    notes.value = noteText;
                }
            }
            
            setTimeout(() => {
                const descField = document.getElementById('paymentDesc');
                if (descField) {
                    descField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    descField.focus();
                }
            }, 500);
        }

        function setupFileInputs() {
            console.log('Setting up file inputs...');
            
            const cameraInput = document.getElementById('invoiceFileCamera');
            if (cameraInput && !cameraInput.dataset.listenerAttached) {
                cameraInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    console.log('Camera file selected:', file.name);
                    document.getElementById('invoiceFileName').textContent = '📸 ' + file.name;
                    
                    if (file.type.startsWith('image/')) {
                        await processInvoice(file);
                    }
                });
                cameraInput.dataset.listenerAttached = 'true';
            }
            
            const uploadInput = document.getElementById('invoiceFileUpload');
            if (uploadInput && !uploadInput.dataset.listenerAttached) {
                uploadInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const fileName = file.name;
                    console.log('Upload file selected:', fileName);
                    document.getElementById('invoiceFileName').textContent = '📁 ' + fileName;
                    
                    if (file.type.startsWith('image/')) {
                        await processInvoice(file);
                    } else if (file.type === 'application/pdf') {
                        const preview = document.getElementById('invoicePreview');
                        const previewImage = document.getElementById('previewImage');
                        if (preview && previewImage) {
                            previewImage.style.display = 'none';
                            preview.classList.add('active');
                            
                            const filenameData = extractFromFilename(fileName);
                            
                            document.getElementById('extractedData').innerHTML = `
                                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                                    <div style="font-size: 48px; margin-bottom: 12px;">📄</div>
                                    <div style="font-weight: 600; margin-bottom: 8px;">PDF Uploaded</div>
                                    <div style="font-size: 14px;">OCR only works with images. Fill in details manually or take a photo.</div>
                                </div>
                            `;
                            
                            if (filenameData.description || filenameData.invoiceNumber) {
                                autoFillForm(filenameData);
                            }
                        }
                    }
                });
                uploadInput.dataset.listenerAttached = 'true';
            }
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker registration failed:', err));
        }

        console.log('App initialized successfully');
    </script>
</body>
</html>
